import{G as wt,h as St,C as kt}from"./GeometryClipper-OrdjW0tI.js";import{a as Pt}from"./TilesRenderer-BHwrq4_L.js";import{T as It}from"./EPSGTilesPlugin-Bm0mhMnw.js";import{aY as Ct,ak as Et,f as Mt,i as Nt,m as X,al as ot,e as Vt,Z as Ot,$ as zt,aZ as Gt,z as Bt,M as nt,ao as Dt,V as dt}from"./three.module-DBfedTbk.js";import{L as Ht}from"./BatchTable-CRr3zuRk.js";import{E as Ut}from"./Ellipsoid-CLPX16sm.js";import{a as Ft}from"./TiledImageSource-smoHuTDQ.js";import{P as jt}from"./TMSImageSource-D41Rs33p.js";const ft="https://tile.googleapis.com/v1/createSession";class qt{get isMapTilesSession(){return this.authURL===ft}constructor(t={}){const{apiToken:e,sessionOptions:s=null,autoRefreshToken:n=!1,proxyURL:i=null}=t;this.apiToken=e,this.autoRefreshToken=n,this.authURL=ft,this.sessionToken=null,this.sessionOptions=s,this._tokenRefreshPromise=null,this.proxyURL=i}async fetch(t,e){this.sessionToken===null&&this.isMapTilesSession&&this.refreshToken(e),await this._tokenRefreshPromise;const s=new URL(t);s.searchParams.set("key",this.apiToken),this.sessionToken&&s.searchParams.set("session",this.sessionToken);let n=s;this.proxyURL&&(n=new URL(this.proxyURL),n.searchParams.set("url",s.toString()));let i=await fetch(n,e);return i.status>=400&&i.status<=499&&this.autoRefreshToken&&(await this.refreshToken(e),this.sessionToken&&s.searchParams.set("session",this.sessionToken),this.proxyURL?(n=new URL(this.proxyURL),n.searchParams.set("url",s.toString())):n=s,i=await fetch(n,e)),this.sessionToken===null&&!this.isMapTilesSession?i.json().then(l=>(this.sessionToken=gt(l),l)):i}refreshToken(t){if(this._tokenRefreshPromise===null){const e=new URL(this.authURL);e.searchParams.set("key",this.apiToken);const s={...t};this.isMapTilesSession&&(s.method="POST",s.body=JSON.stringify(this.sessionOptions),s.headers=s.headers||{},s.headers={...s.headers,"Content-Type":"application/json"});let n=e;this.proxyURL&&(n=new URL(this.proxyURL),n.searchParams.set("url",e.toString())),this._tokenRefreshPromise=fetch(n,s).then(i=>{if(!i.ok)throw new Error(`GoogleCloudAuth: Failed to load data with error code ${i.status}`);return i.json()}).then(i=>(this.sessionToken=gt(i),this._tokenRefreshPromise=null,i))}return this._tokenRefreshPromise}}function gt(L){if("session"in L)return L.session;{let t=null;const e=L.root;return Pt(e,s=>{if(s.content&&s.content.uri){const[,n]=s.content.uri.split("?");return t=new URLSearchParams(n).get("session"),!0}return!1}),t}}function ht(L){return L>>1^-(L&1)}class Qt extends Ht{constructor(...t){super(...t),this.fetchOptions.header={Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9"}}loadAsync(...t){const{fetchOptions:e}=this;return e.header=e.header||{},e.header.Accept="application/vnd.quantized-mesh,application/octet-stream;q=0.9",e.header.Accept+=";extensions=octvertexnormals-watermask-metadata",super.loadAsync(...t)}parse(t){let e=0;const s=new DataView(t),n=()=>{const a=s.getFloat64(e,!0);return e+=8,a},i=()=>{const a=s.getFloat32(e,!0);return e+=4,a},l=()=>{const a=s.getUint32(e,!0);return e+=4,a},b=()=>{const a=s.getUint8(e);return e+=1,a},h=(a,O)=>{const H=new O(t,e,a);return e+=a*O.BYTES_PER_ELEMENT,H},m={center:[n(),n(),n()],minHeight:i(),maxHeight:i(),sphereCenter:[n(),n(),n()],sphereRadius:n(),horizonOcclusionPoint:[n(),n(),n()]},p=l(),d=h(p,Uint16Array),E=h(p,Uint16Array),v=h(p,Uint16Array),c=new Float32Array(p),y=new Float32Array(p),T=new Float32Array(p);let g=0,_=0,G=0;const o=32767;for(let a=0;a<p;++a)g+=ht(d[a]),_+=ht(E[a]),G+=ht(v[a]),c[a]=g/o,y[a]=_/o,T[a]=G/o;const f=p>65536,w=f?Uint32Array:Uint16Array;f?e=Math.ceil(e/4)*4:e=Math.ceil(e/2)*2;const R=l(),V=h(R*3,w);let q=0;for(var Y=0;Y<V.length;++Y){const a=V[Y];V[Y]=q-a,a===0&&++q}const J=(a,O)=>y[O]-y[a],F=(a,O)=>-J(a,O),j=(a,O)=>c[a]-c[O],r=(a,O)=>-j(a,O),u=l(),U=h(u,w);U.sort(J);const I=l(),x=h(I,w);x.sort(j);const M=l(),C=h(M,w);C.sort(F);const S=l(),k=h(S,w);k.sort(r);const A={westIndices:U,southIndices:x,eastIndices:C,northIndices:k},N={};for(;e<s.byteLength;){const a=b(),O=l();if(a===1){const H=h(p*2,Uint8Array),B=new Float32Array(p*3);for(let Q=0;Q<p;Q++){let Z=H[2*Q+0]/255*2-1,$=H[2*Q+1]/255*2-1;const it=1-(Math.abs(Z)+Math.abs($));if(it<0){const mt=Z;Z=(1-Math.abs($))*yt(mt),$=(1-Math.abs(mt))*yt($)}const lt=Math.sqrt(Z*Z+$*$+it*it);B[3*Q+0]=Z/lt,B[3*Q+1]=$/lt,B[3*Q+2]=it/lt}N.octvertexnormals={extensionId:a,normals:B}}else if(a===2){const H=O===1?1:256,B=h(H*H,Uint8Array);N.watermask={extensionId:a,mask:B,size:H}}else if(a===4){const H=l(),B=h(H,Uint8Array),Q=new TextDecoder().decode(B);N.metadata={extensionId:a,json:JSON.parse(Q)}}}return{header:m,indices:V,vertexData:{u:c,v:y,height:T},edgeIndices:A,extensions:N}}}function yt(L){return L<0?-1:1}class Xt{constructor(){this.creditsCount={}}_adjustAttributions(t,e){const s=this.creditsCount,n=t.split(/;/g);for(let i=0,l=n.length;i<l;i++){const b=n[i];b in s||(s[b]=0),s[b]+=e?1:-1,s[b]<=0&&delete s[b]}}addAttributions(t){this._adjustAttributions(t,!0)}removeAttributions(t){this._adjustAttributions(t,!1)}toString(){return Object.entries(this.creditsCount).sort((e,s)=>{const n=e[1];return s[1]-n}).map(e=>e[0]).join("; ")}}const Yt="https://tile.googleapis.com/v1/3dtiles/root.json";class $t{constructor({apiToken:t,sessionOptions:e=null,autoRefreshToken:s=!1,logoUrl:n=null,useRecommendedSettings:i=!0,proxyURL:l=null}){this.name="GOOGLE_CLOUD_AUTH_PLUGIN",this.apiToken=t,this.useRecommendedSettings=i,this.logoUrl=n,this.proxyURL=l,this.auth=new qt({apiToken:t,autoRefreshToken:s,sessionOptions:e,proxyURL:l}),this.tiles=null,this._visibilityChangeCallback=null,this._attributionsManager=new Xt,this._logoAttribution={value:"",type:"image",collapsible:!1},this._attribution={value:"",type:"string",collapsible:!0}}init(t){const{useRecommendedSettings:e,auth:s}=this;t.resetFailedTiles(),t.rootURL==null&&(t.rootURL=Yt),s.sessionOptions||(s.authURL=t.rootURL),e&&!s.isMapTilesSession&&(t.errorTarget=20),this.tiles=t,this._visibilityChangeCallback=({tile:n,visible:i})=>{var b,h;const l=((h=(b=n.cached.metadata)==null?void 0:b.asset)==null?void 0:h.copyright)||"";i?this._attributionsManager.addAttributions(l):this._attributionsManager.removeAttributions(l)},t.addEventListener("tile-visibility-change",this._visibilityChangeCallback)}getAttributions(t){this.tiles.visibleTiles.size>0&&(this.logoUrl&&(this._logoAttribution.value=this.logoUrl,t.push(this._logoAttribution)),this._attribution.value=this._attributionsManager.toString(),t.push(this._attribution))}dispose(){this.tiles.removeEventListener("tile-visibility-change",this._visibilityChangeCallback)}async fetchData(t,e){return this.auth.fetch(t,e)}}const Lt=new X,rt=new Dt,P=new X,K=new X;class Zt extends Qt{constructor(t=Ct){super(),this.manager=t,this.ellipsoid=new Ut,this.skirtLength=1e3,this.smoothSkirtNormals=!0,this.solid=!1,this.minLat=-Math.PI/2,this.maxLat=Math.PI/2,this.minLon=-Math.PI,this.maxLon=Math.PI}parse(t){const{ellipsoid:e,solid:s,skirtLength:n,smoothSkirtNormals:i,minLat:l,maxLat:b,minLon:h,maxLon:m}=this,{header:p,indices:d,vertexData:E,edgeIndices:v,extensions:c}=super.parse(t),y=new Et,T=new Mt,g=new Nt(y,T);g.position.set(...p.center);const _="octvertexnormals"in c,G=E.u.length,o=[],f=[],w=[],R=[];let V=0,q=0;for(let r=0;r<G;r++)J(r,P),F(P.x,P.y,P.z,K),f.push(P.x,P.y),o.push(...K);for(let r=0,u=d.length;r<u;r++)w.push(d[r]);if(_){const r=c.octvertexnormals.normals;for(let u=0,U=r.length;u<U;u++)R.push(r[u])}if(y.addGroup(V,d.length,q),V+=d.length,q++,s){const r=o.length/3;for(let u=0;u<G;u++)J(u,P),F(P.x,P.y,P.z,K,-n),f.push(P.x,P.y),o.push(...K);for(let u=d.length-1;u>=0;u--)w.push(d[u]+r);if(_){const u=c.octvertexnormals.normals;for(let U=0,I=u.length;U<I;U++)R.push(-u[U])}y.addGroup(V,d.length,q),V+=d.length,q++}if(n>0){const{westIndices:r,eastIndices:u,southIndices:U,northIndices:I}=v;let x;const M=j(r);x=o.length/3,f.push(...M.uv),o.push(...M.positions);for(let A=0,N=M.indices.length;A<N;A++)w.push(M.indices[A]+x);const C=j(u);x=o.length/3,f.push(...C.uv),o.push(...C.positions);for(let A=0,N=C.indices.length;A<N;A++)w.push(C.indices[A]+x);const S=j(U);x=o.length/3,f.push(...S.uv),o.push(...S.positions);for(let A=0,N=S.indices.length;A<N;A++)w.push(S.indices[A]+x);const k=j(I);x=o.length/3,f.push(...k.uv),o.push(...k.positions);for(let A=0,N=k.indices.length;A<N;A++)w.push(k.indices[A]+x);_&&(R.push(...M.normals),R.push(...C.normals),R.push(...S.normals),R.push(...k.normals)),y.addGroup(V,d.length,q),V+=d.length,q++}for(let r=0,u=o.length;r<u;r+=3)o[r+0]-=p.center[0],o[r+1]-=p.center[1],o[r+2]-=p.center[2];const Y=o.length/3>65535?new Uint32Array(w):new Uint16Array(w);if(y.setIndex(new ot(Y,1,!1)),y.setAttribute("position",new ot(new Float32Array(o),3,!1)),y.setAttribute("uv",new ot(new Float32Array(f),2,!1)),_&&y.setAttribute("normal",new ot(new Float32Array(R),3,!1)),"watermask"in c){const{mask:r,size:u}=c.watermask,U=new Uint8Array(2*u*u);for(let x=0,M=r.length;x<M;x++){const C=r[x]===255?0:255;U[2*x+0]=C,U[2*x+1]=C}const I=new Vt(U,u,u,Ot,zt);I.flipY=!0,I.minFilter=Gt,I.magFilter=Bt,I.needsUpdate=!0,T.roughnessMap=I}return g.userData.minHeight=p.minHeight,g.userData.maxHeight=p.maxHeight,"metadata"in c&&(g.userData.metadata=c.metadata.json),g;function J(r,u){return u.x=E.u[r],u.y=E.v[r],u.z=E.height[r],u}function F(r,u,U,I,x=0){const M=nt.lerp(p.minHeight,p.maxHeight,U),C=nt.lerp(h,m,r),S=nt.lerp(l,b,u);return e.getCartographicToPosition(S,C,M+x,I),I}function j(r){const u=[],U=[],I=[],x=[],M=[];for(let k=0,A=r.length;k<A;k++)J(r[k],P),u.push(P.x,P.y),I.push(P.x,P.y),F(P.x,P.y,P.z,K),U.push(...K),F(P.x,P.y,P.z,K,-n),x.push(...K);const C=r.length-1;for(let k=0;k<C;k++){const A=k,N=k+1,a=k+r.length,O=k+r.length+1;M.push(A,a,N),M.push(N,a,O)}let S=null;if(_){const k=(U.length+x.length)/3;if(i){S=new Array(k*3);const A=c.octvertexnormals.normals,N=S.length/2;for(let a=0,O=k/2;a<O;a++){const H=r[a],B=3*a,Q=A[3*H+0],Z=A[3*H+1],$=A[3*H+2];S[B+0]=Q,S[B+1]=Z,S[B+2]=$,S[N+B+0]=Q,S[N+B+1]=Z,S[N+B+2]=$}}else{S=[],rt.a.fromArray(U,0),rt.b.fromArray(x,0),rt.c.fromArray(U,3),rt.getNormal(Lt);for(let A=0;A<k;A++)S.push(...Lt)}}return{uv:[...u,...I],positions:[...U,...x],indices:M,normals:S}}}}const bt={},Jt=new X,ct=new X,ut=new X,Kt=new X,Wt=new X,D=new X,et=new X,z=new dt,W=new dt,xt=new dt;class te extends wt{constructor(){super(),this.ellipsoid=new Ut,this.skirtLength=1e3,this.smoothSkirtNormals=!0,this.solid=!1,this.minLat=-Math.PI/2,this.maxLat=Math.PI/2,this.minLon=-Math.PI,this.maxLon=Math.PI,this.attributeList=["position","normal","uv"]}clipToQuadrant(t,e,s){const{solid:n,skirtLength:i,ellipsoid:l,smoothSkirtNormals:b}=this;this.clearSplitOperations(),this.addSplitOperation(At("x"),!e),this.addSplitOperation(At("y"),!s);let h,m;const p=t.geometry.groups[0],d=this.getClippedData(t,p);if(this.adjustVertices(d,t.position,0),n){h={index:d.index.slice().reverse(),attributes:{}};for(const f in d.attributes)h.attributes[f]=d.attributes[f].slice();const o=h.attributes.normal;if(o)for(let f=0;f<o.length;f+=3)o[f+0]*=-1,o[f+1]*=-1,o[f+2]*=-1;this.adjustVertices(h,t.position,-i)}if(i>0){m={index:[],attributes:{position:[],normal:[],uv:[]}};let o=0;const f={},w=(F,j,r)=>{const u=St(...F,...r,...j);u in f||(f[u]=o,o++,m.attributes.position.push(...F),m.attributes.normal.push(...r),m.attributes.uv.push(...j)),m.index.push(f[u])},R=d.index,V=d.attributes.uv,q=d.attributes.position,Y=d.attributes.normal,J=d.index.length/3;for(let F=0;F<J;F++){const j=3*F;for(let r=0;r<3;r++){const u=(r+1)%3,U=R[j+r],I=R[j+u];if(z.fromArray(V,U*2),W.fromArray(V,I*2),z.x===W.x&&(z.x===0||z.x===.5||z.x===1)||z.y===W.y&&(z.y===0||z.y===.5||z.y===1)){ct.fromArray(q,U*3),ut.fromArray(q,I*3);const x=ct,M=ut,C=Kt.copy(ct),S=Wt.copy(ut);D.copy(C).add(t.position),l.getPositionToNormal(D,D),C.addScaledVector(D,-i),D.copy(S).add(t.position),l.getPositionToNormal(D,D),S.addScaledVector(D,-i),b&&Y?(D.fromArray(Y,U*3),et.fromArray(Y,I*3)):(D.subVectors(x,M),et.subVectors(x,C).cross(D).normalize(),D.copy(et)),w(M,W,et),w(x,z,D),w(C,z,D),w(M,W,et),w(C,z,D),w(S,W,et)}}}}const E=d.index.length,v=d;if(h){const{index:o,attributes:f}=h,w=v.attributes.position.length/3;for(let R=0,V=o.length;R<V;R++)v.index.push(o[R]+w);for(const R in d.attributes)v.attributes[R].push(...f[R])}if(m){const{index:o,attributes:f}=m,w=v.attributes.position.length/3;for(let R=0,V=o.length;R<V;R++)v.index.push(o[R]+w);for(const R in d.attributes)v.attributes[R].push(...f[R])}const c=e?0:-.5,y=s?0:-.5,T=v.attributes.uv;for(let o=0,f=T.length;o<f;o+=2)T[o]=(T[o]+c)*2,T[o+1]=(T[o+1]+y)*2;const g=this.constructMesh(v.attributes,v.index,t);g.userData.minHeight=t.userData.minHeight,g.userData.maxHeight=t.userData.maxHeight;let _=0,G=0;return g.geometry.addGroup(G,E,_),G+=E,_++,h&&(g.geometry.addGroup(G,h.index.length,_),G+=h.index.length,_++),m&&(g.geometry.addGroup(G,m.index.length,_),G+=m.index.length,_++),g}adjustVertices(t,e,s){const{ellipsoid:n,minLat:i,maxLat:l,minLon:b,maxLon:h}=this,{attributes:m,vertexIsClipped:p}=t,d=m.position,E=m.uv,v=d.length/3;for(let c=0;c<v;c++){const y=z.fromArray(E,c*2);p&&p[c]&&(Math.abs(y.x-.5)<1e-10&&(y.x=.5),Math.abs(y.y-.5)<1e-10&&(y.y=.5),z.toArray(E,c*2));const T=nt.lerp(i,l,y.y),g=nt.lerp(b,h,y.x),_=Jt.fromArray(d,c*3).add(e);n.getPositionToCartographic(_,bt),n.getCartographicToPosition(T,g,bt.height+s,_),_.sub(e),_.toArray(d,c*3)}}}function At(L){return(t,e,s,n,i)=>{const l=t.attributes.uv;return z.fromBufferAttribute(l,e),W.fromBufferAttribute(l,s),xt.fromBufferAttribute(l,n),z[L]*i.x+W[L]*i.y+xt[L]*i.z-.5}}const vt=Symbol("TILE_X"),Tt=Symbol("TILE_Y"),st=Symbol("TILE_LEVEL"),tt=Symbol("TILE_AVAILABLE"),at=1e4,Rt=new X;function ee(L,t,e,s){if(L&&t<L.length){const n=L[t];for(let i=0,l=n.length;i<l;i++){const{startX:b,startY:h,endX:m,endY:p}=n[i];if(e>=b&&e<=m&&s>=h&&s<=p)return!0}}return!1}function _t(L){const{available:t=null,maxzoom:e=null}=L;return e===null?t.length-1:e}function se(L){const{metadataAvailability:t=-1}=L;return t}function pt(L,t){const e=L[st],s=se(t),n=_t(t);return e<n&&s!==-1&&e%s===0}function ne(L,t,e,s,n){return n.tiles[0].replace(/{\s*z\s*}/g,e).replace(/{\s*x\s*}/g,L).replace(/{\s*y\s*}/g,t).replace(/{\s*version\s*}/g,s)}class ie{constructor(t={}){const{useRecommendedSettings:e=!0,skirtLength:s=null,smoothSkirtNormals:n=!0,solid:i=!1}=t;this.name="QUANTIZED_MESH_PLUGIN",this.priority=-1e3,this.tiles=null,this.layer=null,this.useRecommendedSettings=e,this.skirtLength=s,this.smoothSkirtNormals=n,this.solid=i,this.attribution=null,this.tiling=new Ft,this.projection=new jt}init(t){t.fetchOptions.headers=t.fetchOptions.headers||{},t.fetchOptions.headers.Accept="application/vnd.quantized-mesh,application/octet-stream;q=0.9",this.useRecommendedSettings&&(t.errorTarget=2),this.tiles=t}loadRootTileSet(){const{tiles:t}=this;let e=new URL("layer.json",new URL(t.rootURL,location.href));return t.invokeAllPlugins(s=>e=s.preprocessURL?s.preprocessURL(e,null):e),t.invokeOnePlugin(s=>s.fetchData&&s.fetchData(e,this.tiles.fetchOptions)).then(s=>s.json()).then(s=>{this.layer=s;const{projection:n="EPSG:4326",extensions:i=[],attribution:l="",available:b=null}=s,{tiling:h,tiles:m,projection:p}=this;l&&(this.attribution={value:l,type:"string",collapsible:!0}),i.length>0&&(m.fetchOptions.headers.Accept+=`;extensions=${i.join("-")}`),p.setScheme(n);const{tileCountX:d,tileCountY:E}=p;h.setProjection(p),h.generateLevels(_t(s)+1,d,E);const v=[];for(let T=0;T<d;T++){const g=this.createChild(0,T,0,b);g&&v.push(g)}const c={asset:{version:"1.1"},geometricError:1/0,root:{refine:"REPLACE",geometricError:1/0,boundingVolume:{region:[...this.tiling.getContentBounds(),-at,at]},children:v,[tt]:b,[st]:-1}};let y=m.rootURL;return m.invokeAllPlugins(T=>y=T.preprocessURL?T.preprocessURL(y,null):y),m.preprocessTileSet(c,y),c})}parseToMesh(t,e,s,n){const{skirtLength:i,solid:l,smoothSkirtNormals:b,tiles:h}=this,m=h.ellipsoid;let p;if(s==="quantized_tile_split"){const c=new URL(n).searchParams,y=c.get("left")==="true",T=c.get("bottom")==="true",g=new te;g.ellipsoid.copy(m),g.solid=l,g.smoothSkirtNormals=b,g.skirtLength=i===null?e.geometricError:i;const[_,G,o,f]=e.parent.boundingVolume.region;g.minLat=G,g.maxLat=f,g.minLon=_,g.maxLon=o,p=g.clipToQuadrant(e.parent.cached.scene,y,T)}else if(s==="terrain"){const c=new Zt(h.manager);c.ellipsoid.copy(m),c.solid=l,c.smoothSkirtNormals=b,c.skirtLength=i===null?e.geometricError:i;const[y,T,g,_]=e.boundingVolume.region;c.minLat=T,c.maxLat=_,c.minLon=y,c.maxLon=g,p=c.parse(t)}else return;const{minHeight:d,maxHeight:E,metadata:v}=p.userData;return e.boundingVolume.region[4]=d,e.boundingVolume.region[5]=E,e.cached.boundingVolume.setRegionData(m,...e.boundingVolume.region),v&&("geometricerror"in v&&(e.geometricError=v.geometricerror),pt(e,this.layer)&&"available"in v&&e.children.length===0&&(e[tt]=[...new Array(e[st]+1).fill(null),...v.available])),this.expandChildren(e),p}getAttributions(t){this.attribution&&t.push(this.attribution)}createChild(t,e,s,n){const{tiles:i,layer:l,tiling:b,projection:h}=this,m=i.ellipsoid,p=n===null&&t===0||ee(n,t,e,s),d=ne(e,s,t,1,l),E=[...b.getTileBounds(e,s,t),-at,at],[,v,,c,,y]=E,T=v>0!=c>0?0:Math.min(Math.abs(v),Math.abs(c));m.getCartographicToPosition(T,0,y,Rt),Rt.z=0;const g=h.tileCountX,o=Math.max(...m.radius)*2*Math.PI*.25/(65*g)/2**t,f={[tt]:null,[st]:t,[vt]:e,[Tt]:s,refine:"REPLACE",geometricError:o,boundingVolume:{region:E},content:p?{uri:d}:null,children:[]};return pt(f,l)||(f[tt]=n),f}expandChildren(t){const e=t[st],s=t[vt],n=t[Tt],i=t[tt];if(e>=this.tiling.maxLevel)return;let l=!1;for(let b=0;b<2;b++)for(let h=0;h<2;h++){const m=this.createChild(e+1,2*s+b,2*n+h,i);m.content!==null?(t.children.push(m),l=!0):(t.children.push(m),m.content={uri:`tile.quantized_tile_split?bottom=${h===0}&left=${b===0}`})}l||(t.children.length=0)}fetchData(t,e){if(/quantized_tile_split/.test(t))return new ArrayBuffer}disposeTile(t){pt(t,this.layer)&&(t[tt]=null),tt in t&&(t.children.forEach(e=>{this.tiles.processNodeQueue.remove(e)}),t.children.length=0,t.__childrenProcessed=0)}}class de{get apiToken(){return this.auth.apiToken}set apiToken(t){this.auth.apiToken=t}get autoRefreshToken(){return this.auth.autoRefreshToken}set autoRefreshToken(t){this.auth.autoRefreshToken=t}constructor({apiToken:t,assetId:e=null,autoRefreshToken:s=!1,useRecommendedSettings:n=!0,googleProxyURL:i=null}){this.name="CESIUM_ION_AUTH_PLUGIN",this.auth=new kt({apiToken:t,autoRefreshToken:s}),this.assetId=e,this.autoRefreshToken=s,this.useRecommendedSettings=n,this.googleProxyURL=i,this.tiles=null,this._tileSetVersion=-1,this._attributions=[]}init(t){this.assetId!==null&&(t.rootURL=`https://api.cesium.com/v1/assets/${this.assetId}/endpoint`),this.tiles=t,this.auth.authURL=t.rootURL,t.resetFailedTiles()}loadRootTileSet(){return this.auth.refreshToken().then(t=>(this._initializeFromAsset(t),this.tiles.invokeOnePlugin(e=>e!==this&&e.loadRootTileSet&&e.loadRootTileSet()))).catch(t=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:t,url:this.auth.authURL})})}preprocessURL(t){return t=new URL(t),/^http/.test(t.protocol)&&this._tileSetVersion!=-1&&t.searchParams.set("v",this._tileSetVersion),t.toString()}fetchData(t,e){return this.tiles.getPluginByName("GOOGLE_CLOUD_AUTH_PLUGIN")!==null?null:this.auth.fetch(t,e)}getAttributions(t){this.tiles.visibleTiles.size>0&&t.push(...this._attributions)}_initializeFromAsset(t){const e=this.tiles;if("externalType"in t){const s=new URL(t.options.url);e.rootURL=t.options.url,e.registerPlugin(new $t({apiToken:s.searchParams.get("key"),autoRefreshToken:this.autoRefreshToken,useRecommendedSettings:this.useRecommendedSettings,proxyURL:this.googleProxyURL}))}else{t.type==="TERRAIN"&&e.getPluginByName("QUANTIZED_MESH_PLUGIN")===null?e.registerPlugin(new ie({useRecommendedSettings:this.useRecommendedSettings})):t.type==="IMAGERY"&&e.getPluginByName("TMS_TILES_PLUGIN")===null&&e.registerPlugin(new It({useRecommendedSettings:this.useRecommendedSettings,shape:"ellipsoid"})),e.rootURL=t.url;const s=new URL(t.url);s.searchParams.has("v")&&this._tileSetVersion===-1&&(this._tileSetVersion=s.searchParams.get("v")),t.attributions&&(this._attributions=t.attributions.map(n=>({value:n.html,type:"html",collapsible:n.collapsible})))}}}export{de as C};
//# sourceMappingURL=CesiumIonAuthPlugin-C57FjJHp.js.map
